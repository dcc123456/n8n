# n8n 项目配置文档

## 配置系统概述

n8n 采用分层配置系统，支持多种配置来源：
1. 环境变量
2. 配置文件
3. 命令行参数
4. 数据库配置

配置系统主要由 `@n8n/config` 包管理，使用装饰器模式定义配置选项。

## 主要配置模块

### 1. 全局配置 (@n8n/config)

#### User Management 配置
- **N8N_SMTP_HOST**: SMTP 服务器主机地址
- **N8N_SMTP_PORT**: SMTP 服务器端口（默认 465）
- **N8N_SMTP_SSL**: 是否使用 SSL 连接（默认 true）
- **N8N_SMTP_STARTTLS**: 是否使用 STARTTLS（当 SSL 禁用时，默认 true）
- **N8N_SMTP_USER**: SMTP 登录用户名
- **N8N_SMTP_PASS**: SMTP 登录密码
- **N8N_SMTP_SENDER**: 发件人显示名称
- **N8N_UM_EMAIL_TEMPLATES_INVITE**: 邀请邮件模板路径
- **N8N_UM_EMAIL_TEMPLATES_PWRESET**: 密码重置邮件模板路径

#### Database 配置
- **DB_TYPE**: 数据库类型（sqlite, postgres, mysql, mariadb）
- **DB_SQLITE_DATABASE**: SQLite 数据库路径
- **DB_POSTGRES_HOST**: PostgreSQL 主机地址
- **DB_POSTGRES_PORT**: PostgreSQL 端口
- **DB_POSTGRES_USER**: PostgreSQL 用户名
- **DB_POSTGRES_PASSWORD**: PostgreSQL 密码
- **DB_POSTGRES_DB**: PostgreSQL 数据库名

#### Security 配置
- **N8N_BASIC_AUTH_ACTIVE**: 是否启用基本认证
- **N8N_BASIC_AUTH_USER**: 基本认证用户名
- **N8N_BASIC_AUTH_PASSWORD**: 基本认证密码
- **N8N_SECURITY_PRESET**: 安全预设（none, audit, compliance）
- **N8N_ENCRYPTION_KEY**: 数据加密密钥

#### CORS 配置
- **N8N_CORS_ORIGIN**: 允许的来源域名
- **N8N_CORS_CREDENTIALS**: 是否允许凭证

#### Rate Limiting 配置
- **N8N_API_RATE_LIMIT_MAX**: API 速率限制最大请求数
- **N8N_API_RATE_LIMIT_WINDOW**: API 速率限制时间窗口

#### Queue Mode 配置
- **EXECUTIONS_MODE**: 执行模式（regular, queue）
- **QUEUE_BULL_REDIS_HOST**: Redis 主机地址
- **QUEUE_BULL_REDIS_PORT**: Redis 端口
- **QUEUE_BULL_REDIS_PASSWORD**: Redis 密码

### 2. 系统配置

#### 服务配置
- **N8N_HOST**: n8n 服务绑定的主机地址（默认 localhost）
- **N8N_PORT**: n8n 服务端口号（默认 5678）
- **N8N_PROTOCOL**: 协议（http, https）
- **N8N_PATH**: n8n 服务的基础路径（用于反向代理）

#### 执行配置
- **EXECUTIONS_PROCESS**: 工作流执行模式（own, main）
- **EXECUTIONS_TIMEOUT**: 执行超时时间
- **EXECUTIONS_TIMEOUT_MAX**: 最大执行超时时间
- **EXECUTIONS_DATA_SAVE_PER_EXECUTION**: 每次执行保存的最大数据量
- **EXECUTIONS_DATA_SAVE_ON_ERROR**: 出错时是否保存执行数据
- **EXECUTIONS_DATA_SAVE_ON_PROGRESS**: 执行过程中是否保存进度数据

#### 缓存配置
- **N8N_CACHE_ENABLED**: 是否启用缓存
- **N8N_CACHE_BACKEND**: 缓存后端（memory, redis）
- **N8N_CACHE_REDIS_HOST**: Redis 缓存主机
- **N8N_CACHE_REDIS_PORT**: Redis 缓存端口

#### 日志配置
- **N8N_LOG_LEVEL**: 日志级别（error, warn, info, verbose, debug）
- **N8N_LOG_OUTPUT**: 日志输出方式（console, file）
- **N8N_LOG_FILE**: 日志文件路径

### 3. 功能开关配置

#### 二八定律配置
- **N8N_PERSONALIZATION_ENABLED**: 是否启用个性化数据收集
- **N8N_DIAGNOSTICS_ENABLED**: 是否启用诊断数据收集
- **N8N_TELEMETRY_ENABLED**: 是否启用遥测

#### 外部集成配置
- **N8N_SENTRY_DSN**: Sentry 错误跟踪 DSN
- **N8N_POSTHOG_HOST**: PostHog 分析服务主机
- **N8N_POSTHOG_API_KEY**: PostHog 分析服务 API 密钥

#### AI 相关配置
- **N8N_AI_ENABLED**: 是否启用 AI 功能
- **N8N_MIME_AUDIO_ENABLED**: 是否启用音频 MIME 类型处理
- **N8N_MIME_VIDEO_ENABLED**: 是否启用视频 MIME 类型处理

### 4. SSO 配置

#### SAML 配置
- **N8N_SSO_SAML_LOGIN_ENABLED**: 是否启用 SAML 登录
- **N8N_SSO_SAML_ATTR_MAPPING_ID**: SAML ID 属性映射
- **N8N_SSO_SAML_ATTR_MAPPING_EMAIL**: SAML 邮箱属性映射
- **N8N_SSO_SAML_ATTR_MAPPING_FIRST_NAME**: SAML 名字属性映射
- **N8N_SSO_SAML_ATTR_MAPPING_LAST_NAME**: SAML 姓氏属性映射

#### LDAP 配置
- **N8N_SSO_LDAP_LOGIN_ENABLED**: 是否启用 LDAP 登录
- **N8N_SSO_LDAP_SERVER_URL**: LDAP 服务器 URL
- **N8N_SSO_LDAP_SERVER_PORT**: LDAP 服务器端口
- **N8N_SSO_LDAP_BIND_USER_DN**: LDAP 绑定用户 DN
- **N8N_SSO_LDAP_BIND_USER_PASSWORD**: LDAP 绑定用户密码

## 配置文件位置

### 主要配置文件
- `packages/@n8n/config/src/configs/`: 各模块的配置定义
- `packages/@n8n/config/src/decorators/`: 配置装饰器
- `packages/cli/src/config/`: CLI 特定配置

### 配置加载顺序
1. 默认值
2. 配置文件
3. 环境变量
4. 命令行参数

## 配置验证

n8n 使用 Zod 进行配置验证，确保配置值符合预期类型和范围。所有配置都有明确的数据类型和验证规则。

## 环境特定配置

### 开发环境
- `NODE_ENV=development`
- 启用更多调试信息
- 热重载功能开启

### 生产环境
- `NODE_ENV=production`
- 性能优化
- 安全强化

### 测试环境
- `NODE_ENV=test`
- 模拟数据和测试专用配置
- 额外的测试工具启用

## 配置最佳实践

1. **安全性**: 敏感信息（如密码、API 密钥）应通过环境变量提供，不要写入配置文件
2. **可维护性**: 使用有意义的环境变量名称，便于理解用途
3. **文档化**: 在文档中详细说明所有自定义配置项的作用
4. **默认值**: 为配置项提供合理的默认值，使应用可以在最小配置下运行
5. **验证**: 利用 n8n 的内置验证机制确保配置有效性